<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysAluguel</title>
    <!-- Adiciona a biblioteca do Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Adiciona a fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
    <div id="root"></div>

    <!-- Carrega React, ReactDOM e Babel a partir de CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Carrega as bibliotecas do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, doc, addDoc, setDoc, onSnapshot, serverTimestamp, deleteDoc };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // ====================================================================================
        // === CREDENCIAIS DO PROJETO FIREBASE ATUALIZADAS ===
        // Agora o aplicativo utiliza as credenciais de configuração e o token de autenticação
        // fornecidos pelo ambiente do Canvas.
        // ====================================================================================
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Use um ID de aplicativo padrão se não for fornecido, embora o Canvas sempre o forneça.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const navigationItems = [
            { name: 'Dashboard', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 17H12a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2.5"/><path d="M8.5 17H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2.5"/><path d="M17.5 17H20a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2.5"/></svg>, view: 'dashboard' },
            { name: 'Inquilinos', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>, view: 'tenants' },
            { name: 'Proprietários', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22v-6a3 3 0 0 1 6 0v6"/></svg>, view: 'owners' },
            { name: 'Imóveis', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>, view: 'properties' },
            { name: 'Pagamentos', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>, view: 'payments' },
            { name: 'Contrato', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>, view: 'contract' },
        ];

        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            }).format(value);
        };

        const formatDate = (date) => {
            if (!date) return 'N/A';
            return new Date(date).toLocaleDateString('pt-BR');
        };

        const Card = ({ title, description, children, icon }) => (
            <div className="rounded-lg border bg-white text-gray-900 shadow-sm p-6 flex flex-col justify-between">
                <div className="flex flex-row items-center justify-between pb-2">
                    <h3 className="text-sm font-medium">{title}</h3>
                    <div className="h-4 w-4 text-gray-400">{icon}</div>
                </div>
                <div className="flex-1">{children}</div>
                {description && <p className="text-sm text-gray-500 mt-2">{description}</p>}
            </div>
        );

        const Button = ({ children, onClick, variant = 'default', size = 'md', className = '', ...props }) => {
            let baseStyle = "inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none";
            let variantStyle = "";
            let sizeStyle = "";

            switch (variant) {
                case 'destructive':
                    variantStyle = "bg-red-500 text-white hover:bg-red-600 focus-visible:ring-red-500";
                    break;
                case 'outline':
                    variantStyle = "border border-gray-200 bg-white text-gray-900 hover:bg-gray-100 hover:text-gray-900";
                    break;
                default:
                    variantStyle = "bg-indigo-600 text-white hover:bg-indigo-700 focus-visible:ring-indigo-500";
            }

            switch (size) {
                case 'sm':
                    sizeStyle = "h-8 px-3 text-xs";
                    break;
                case 'lg':
                    sizeStyle = "h-12 px-6";
                    break;
                default:
                    sizeStyle = "h-10 px-4 py-2";
            }

            return (
                <button className={`${baseStyle} ${variantStyle} ${sizeStyle} ${className}`} onClick={onClick} {...props}>
                    {children}
                </button>
            );
        };

        const Dialog = ({ open, onOpenChange, title, description, children }) => {
            if (!open) return null;
            return (
                <div className="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50 flex justify-center items-center">
                    <div className="relative w-full max-w-md p-6 rounded-lg bg-white dark:bg-gray-800 shadow-lg m-4">
                        <div className="flex justify-between items-start">
                            <div>
                                <h2 className="text-lg font-semibold text-gray-900 dark:text-white">{title}</h2>
                                {description && <p className="text-sm text-gray-500">{description}</p>}
                            </div>
                            <button onClick={() => onOpenChange(false)} className="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4 text-gray-500"><path d="M18 6L6 18M6 6l12 12"/></svg>
                            </button>
                        </div>
                        <div className="mt-4">{children}</div>
                    </div>
                </div>
            );
        };

        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [firebaseError, setFirebaseError] = useState(null);

            const [view, setView] = useState('dashboard');
            const [tenants, setTenants] = useState([]);
            const [owners, setOwners] = useState([]);
            const [properties, setProperties] = useState([]);
            const [payments, setPayments] = useState([]);

            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalTitle, setModalTitle] = useState('');
            const [modalContent, setModalContent] = useState(null);
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [confirmModalData, setConfirmModalData] = useState(null);

            const openModal = (title, content) => {
                setModalTitle(title);
                setModalContent(content);
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setModalContent(null);
                setModalTitle('');
            };

            useEffect(() => {
                // Checa se a configuração do Firebase está disponível
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                    setFirebaseError("A configuração do Firebase está faltando ou os scripts do Firebase não foram carregados.");
                    setLoading(false);
                    return;
                }
                const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.firebase;

                try {
                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);

                    setAuth(authInstance);
                    setDb(dbInstance);

                    const authenticate = async () => {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(authInstance, initialAuthToken);
                            } else {
                                await signInAnonymously(authInstance);
                            }
                        } catch (error) {
                            console.error("Firebase authentication failed:", error);
                            setFirebaseError(`Falha na autenticação do Firebase: ${error.message}. Isso pode ser devido a credenciais inválidas ou a um método de autenticação não ativado no seu projeto.`);
                        }
                    };
                    authenticate();

                    const unsubscribeAuth = onAuthStateChanged(authInstance, (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            setUserId(null);
                        }
                        setLoading(false);
                    });

                    return () => unsubscribeAuth();
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    setFirebaseError(`Falha na inicialização do Firebase: ${error.message}. Verifique sua configuração.`);
                    setLoading(false);
                }

            }, []);

            useEffect(() => {
                if (!db || !userId) {
                    return;
                }
                const { collection, onSnapshot } = window.firebase;

                const unsubscribeTenants = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/tenants`), (snapshot) => {
                    const tenantData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTenants(tenantData);
                }, (error) => console.error("Error fetching tenants:", error));

                const unsubscribeOwners = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/owners`), (snapshot) => {
                    const ownerData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setOwners(ownerData);
                }, (error) => console.error("Error fetching owners:", error));

                const unsubscribeProperties = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/properties`), (snapshot) => {
                    const propertyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProperties(propertyData);
                }, (error) => console.error("Error fetching properties:", error));

                const unsubscribePayments = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/payments`), (snapshot) => {
                    const paymentData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPayments(paymentData);
                }, (error) => console.error("Error fetching payments:", error));

                return () => {
                    unsubscribeTenants();
                    unsubscribeOwners();
                    unsubscribeProperties();
                    unsubscribePayments();
                };
            }, [db, userId]);

            const handleAdd = async (collectionName, data) => {
                if (!db || !userId) return;
                try {
                    const { collection, addDoc, serverTimestamp } = window.firebase;
                    const docRef = collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
                    await addDoc(docRef, { ...data, createdAt: serverTimestamp() });
                    console.log(`Novo(a) ${collectionName.slice(0, -1)} adicionado(a) com sucesso!`);
                    closeModal();
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            };

            const handleUpdate = async (collectionName, id, data) => {
                if (!db || !userId) return;
                try {
                    const { doc, setDoc, serverTimestamp } = window.firebase;
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, id);
                    await setDoc(docRef, { ...data, updatedAt: serverTimestamp() }, { merge: true });
                    console.log(`${collectionName.slice(0, -1)} atualizado(a) com sucesso!`);
                    closeModal();
                } catch (e) {
                    console.error("Error updating document: ", e);
                }
            };

            const handleDelete = async (collectionName, id) => {
                if (!db || !userId) return;
                try {
                    const { doc, deleteDoc } = window.firebase;
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, id);
                    await deleteDoc(docRef);
                    console.log(`${collectionName.slice(0, -1)} excluído(a) com sucesso!`);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                }
            };

            const handleGeneratePayments = async () => {
                if (!db || !userId) return;
                try {
                    const { collection, addDoc, serverTimestamp } = window.firebase;
                    const newPayments = properties.filter(p => p.tenantId).map(property => {
                        const tenant = tenants.find(t => t.id === property.tenantId);
                        return tenant ? {
                            tenantId: tenant.id,
                            propertyId: property.id,
                            tenantName: tenant.name,
                            propertyName: property.address,
                            amount: parseFloat(property.rent),
                            dueDate: new Date().toISOString(),
                            status: 'Aberto',
                            createdAt: serverTimestamp(),
                        } : null;
                    }).filter(Boolean);

                    for (const payment of newPayments) {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/payments`), payment);
                    }
                    console.log('Pagamentos mensais gerados com sucesso!');
                } catch (error) {
                    console.error("Error generating payments:", error);
                }
            };

            const Dashboard = () => {
                const totalProperties = properties.length;
                const rentedProperties = properties.filter(p => p.tenantId).length;
                const totalPayments = payments.length;
                const latePayments = payments.filter(p => p.status === 'Atrasado').length;
                const openPayments = payments.filter(p => p.status === 'Aberto').length;

                return (
                    <div className="space-y-6 p-6">
                        <h2 className="text-3xl font-bold">Dashboard</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <Card title="Imóveis Totais" icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4 text-gray-400"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>}>
                                <div className="text-2xl font-bold">{totalProperties}</div>
                            </Card>
                            <Card title="Imóveis Alugados" icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4 text-gray-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.5"/><polyline points="22 4 12 14.01 9 11.01"/></svg>}>
                                <div className="text-2xl font-bold">{rentedProperties}</div>
                            </Card>
                            <Card title="Pagamentos em Aberto" icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4 text-gray-400"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>}>
                                <div className="text-2xl font-bold">{openPayments}</div>
                            </Card>
                            <Card title="Inadimplência" icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4 text-gray-400"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>}>
                                <div className="text-2xl font-bold">{latePayments}</div>
                            </Card>
                        </div>
                        <div className="mt-8">
                            <h3 className="text-2xl font-semibold mb-4">Pagamentos Recentes</h3>
                            <div className="rounded-md border overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50 dark:bg-gray-700">
                                    <tr className="border-b">
                                        <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Inquilino</th>
                                        <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Imóvel</th>
                                        <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Valor</th>
                                        <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Status</th>
                                        <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Vencimento</th>
                                    </tr>
                                    </thead>
                                    <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200">
                                    {payments.slice(0, 5).map((payment) => (
                                        <tr key={payment.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <td className="px-6 py-4 whitespace-nowrap">{payment.tenantName}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{payment.propertyName}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{formatCurrency(payment.amount)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                                    payment.status === 'Pago' ? 'bg-green-100 text-green-800' :
                                                        payment.status === 'Atrasado' ? 'bg-red-100 text-red-800' :
                                                            'bg-yellow-100 text-yellow-800'
                                                }`}>
                                                  {payment.status}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">{formatDate(payment.dueDate)}</td>
                                        </tr>
                                    ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const TenantForm = ({ item }) => {
                const [name, setName] = useState(item?.name || '');
                const [cpf, setCpf] = useState(item?.cpf || '');
                const [contact, setContact] = useState(item?.contact || '');
                const [address, setAddress] = useState(item?.address || '');

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    const data = { name, cpf, contact, address };
                    if (item?.id) {
                        await handleUpdate('tenants', item.id, data);
                    } else {
                        await handleAdd('tenants', data);
                    }
                };

                return (
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <label className="block text-sm font-medium">Nome</label>
                        <input className="w-full px-3 py-2 border rounded-md" value={name} onChange={(e) => setName(e.target.value)} required />
                        <label className="block text-sm font-medium">CPF</label>
                        <input className="w-full px-3 py-2 border rounded-md" value={cpf} onChange={(e) => setCpf(e.target.value)} required />
                        <label className="block text-sm font-medium">Contato</label>
                        <input className="w-full px-3 py-2 border rounded-md" value={contact} onChange={(e) => setContact(e.target.value)} required />
                        <label className="block text-sm font-medium">Endereço</label>
                        <input className="w-full px-3 py-2 border rounded-md" value={address} onChange={(e) => setAddress(e.target.value)} required />
                        <Button type="submit" className="w-full">{item?.id ? 'Atualizar' : 'Salvar'}</Button>
                    </form>
                );
            };

            const OwnerForm = ({ item }) => {
                const [name, setName] = useState(item?.name || '');
                const [cpf, setCpf] = useState(item?.cpf || '');
                const [contact, setContact] = useState(item?.contact || '');

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    const data = { name, cpf, contact };
                    if (item?.id) {
                        await handleUpdate('owners', item.id, data);
                    } else {
                        await handleAdd('owners', data);
                    }
                };

                return (
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <label className="block text-sm font-medium">Nome</label>
                        <input className="w-full px-3 py-2 border rounded-md" value={name} onChange={(e) => setName(e.target.value)} required />
                        <label className="block text-sm font-medium">CPF/CNPJ</label>
                        <input className="w-full px-3 py-2 border rounded-md" value={cpf} onChange={(e) => setCpf(e.target.value)} required />
                        <label className="block text-sm font-medium">Contato</label>
                        <input className="w-full px-3 py-2 border rounded-md" value={contact} onChange={(e) => setContact(e.target.value)} required />
                        <Button type="submit" className="w-full">{item?.id ? 'Atualizar' : 'Salvar'}</Button>
                    </form>
                );
            };

            const PropertyForm = ({ item }) => {
                const [address, setAddress] = useState(item?.address || '');
                const [rent, setRent] = useState(item?.rent || '');
                const [type, setType] = useState(item?.type || '');
                const [ownerId, setOwnerId] = useState(item?.ownerId || '');
                const [tenantId, setTenantId] = useState(item?.tenantId || '');

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    const data = { address, rent: parseFloat(rent), type, ownerId, tenantId };
                    if (item?.id) {
                        await handleUpdate('properties', item.id, data);
                    } else {
                        await handleAdd('properties', data);
                    }
                };

                return (
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <label className="block text-sm font-medium">Endereço</label>
                        <input className="w-full px-3 py-2 border rounded-md" value={address} onChange={(e) => setAddress(e.target.value)} required />
                        <label className="block text-sm font-medium">Tipo</label>
                        <select value={type} onChange={(e) => setType(e.target.value)} className="w-full px-3 py-2 border rounded-md" required>
                            <option value="">Selecione o tipo</option>
                            <option value="apartamento">Apartamento</option>
                            <option value="casa">Casa</option>
                            <option value="terreno">Terreno</option>
                            <option value="comercial">Comercial</option>
                        </select>
                        <label className="block text-sm font-medium">Aluguel Mensal</label>
                        <input type="number" className="w-full px-3 py-2 border rounded-md" value={rent} onChange={(e) => setRent(e.target.value)} required />
                        <label className="block text-sm font-medium">Proprietário</label>
                        <select value={ownerId} onChange={(e) => setOwnerId(e.target.value)} className="w-full px-3 py-2 border rounded-md" required>
                            <option value="">Selecione um proprietário</option>
                            {owners.map(o => (
                                <option key={o.id} value={o.id}>{o.name}</option>
                            ))}
                        </select>
                        <label className="block text-sm font-medium">Inquilino</label>
                        <select value={tenantId} onChange={(e) => setTenantId(e.target.value)} className="w-full px-3 py-2 border rounded-md">
                            <option value="">Selecione um inquilino (Opcional)</option>
                            {tenants.map(t => (
                                <option key={t.id} value={t.id}>{t.name}</option>
                            ))}
                        </select>
                        <Button type="submit" className="w-full">{item?.id ? 'Atualizar' : 'Salvar'}</Button>
                    </form>
                );
            };

            const Payments = () => {
                const handlePay = async (payment) => {
                    await handleUpdate('payments', payment.id, { status: 'Pago' });
                };

                return (
                    <div className="space-y-6 p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-3xl font-bold">Pagamentos</h2>
                            <Button onClick={handleGeneratePayments}>Gerar Pagamentos do Mês</Button>
                        </div>
                        <div className="rounded-md border overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50 dark:bg-gray-700">
                                <tr className="border-b">
                                    <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Inquilino</th>
                                    <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Imóvel</th>
                                    <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Valor</th>
                                    <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Status</th>
                                    <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Vencimento</th>
                                    <th className="px-6 py-3 text-right font-medium text-gray-500 uppercase">Ações</th>
                                </tr>
                                </thead>
                                <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200">
                                {payments.length === 0 ? (
                                    <tr>
                                        <td colSpan={6} className="px-6 py-4 text-center text-gray-500">Nenhum pagamento registrado.</td>
                                    </tr>
                                ) : (
                                    payments.map(payment => (
                                        <tr key={payment.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <td className="px-6 py-4 whitespace-nowrap">{payment.tenantName}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{payment.propertyName}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">{formatCurrency(payment.amount)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                                    payment.status === 'Pago' ? 'bg-green-100 text-green-800' :
                                                        payment.status === 'Atrasado' ? 'bg-red-100 text-red-800' :
                                                            'bg-yellow-100 text-yellow-800'
                                                }`}>
                                                  {payment.status}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">{formatDate(payment.dueDate)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right">
                                                {payment.status !== 'Pago' && (
                                                    <Button onClick={() => handlePay(payment)} size="sm">Marcar como Pago</Button>
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const ContractView = () => {
                const [selectedPropertyId, setSelectedPropertyId] = useState('');
                const [contractText, setContractText] = useState('');

                const generateContract = () => {
                    if (!selectedPropertyId) {
                        setContractText('Selecione um imóvel para gerar o contrato.');
                        return;
                    }

                    const property = properties.find(p => p.id === selectedPropertyId);
                    if (!property) {
                        setContractText('Imóvel não encontrado.');
                        return;
                    }

                    const tenant = tenants.find(t => t.id === property.tenantId);
                    const owner = owners.find(o => o.id === property.ownerId);

                    if (!tenant || !owner) {
                        setContractText('Inquilino ou proprietário não associados a este imóvel.');
                        return;
                    }

                    const today = new Date().toLocaleDateString('pt-BR');
                    const contractTemplate = `
      CONTRATO DE LOCAÇÃO DE IMÓVEL RESIDENCIAL

      PARTES:

      LOCADOR(A): ${owner.name}, CPF nº ${owner.cpf}, residente e domiciliado(a) em ${owner.contact}.
      LOCATÁRIO(A): ${tenant.name}, CPF nº ${tenant.cpf}, residente e domiciliado(a) em ${tenant.address}.

      OBJETO:

      O presente contrato tem como objeto a locação do imóvel localizado em ${property.address}.

      CLÁUSULAS:

      CLÁUSULA PRIMEIRA - DO VALOR DO ALUGUEL: O valor mensal do aluguel é de ${formatCurrency(property.rent)}, a ser pago até o dia 5 de cada mês.

      CLÁUSULA SEGUNDA - DA VIGÊNCIA: O prazo de locação é de 30 (trinta) meses, iniciando-se em ${today}.

      CLÁUSULA TERCEIRA - DO REAJUSTE: O valor do aluguel será reajustado anualmente pelo índice IGP-M/FGV.

      CLÁUSULA QUARTA - DA MULTA: O atraso no pagamento implicará em multa de 10% sobre o valor devido, mais juros de mora de 1% ao mês.

      E por estarem justos e contratados, assinam o presente contrato em duas vias de igual teor e forma.

      __________________________________
      ${owner.name} (LOCADOR)

      __________________________________
      ${tenant.name} (LOCATÁRIO)
      `;
                    setContractText(contractTemplate);
                };

                return (
                    <div className="space-y-6 p-6">
                        <h2 className="text-3xl font-bold">Contrato Padrão</h2>
                        <Card title="Gerar Contrato" description="Selecione um imóvel para gerar o contrato automaticamente.">
                            <div className="space-y-4">
                                <select value={selectedPropertyId} onChange={(e) => setSelectedPropertyId(e.target.value)} className="w-full px-3 py-2 border rounded-md">
                                    <option value="">Selecione um imóvel</option>
                                    {properties.map(p => (
                                        <option key={p.id} value={p.id}>{p.address}</option>
                                    ))}
                                </select>
                                <Button onClick={generateContract} className="w-full">Gerar Contrato</Button>
                                {contractText && (
                                    <div className="mt-4 p-4 border rounded-lg bg-gray-50 dark:bg-gray-800 whitespace-pre-wrap font-mono text-sm">
                                        {contractText}
                                    </div>
                                )}
                            </div>
                        </Card>
                    </div>
                );
            };

            const TableView = ({ title, collectionName, data, FormComponent }) => {
                const handleEditClick = (item) => {
                    openModal(`Editar ${title.slice(0, -1)}`, <FormComponent item={item} />);
                };

                return (
                    <div className="space-y-6 p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-3xl font-bold">{title}</h2>
                            <Button onClick={() => openModal(`Adicionar ${title.slice(0, -1)}`, <FormComponent />)}><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2 h-4 w-4"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Adicionar {title}</Button>
                        </div>
                        <div className="rounded-md border overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50 dark:bg-gray-700">
                                <tr className="border-b">
                                    <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Endereço</th>
                                    {collectionName === 'tenants' && <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">CPF</th>}
                                    {collectionName === 'owners' && <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">CPF/CNPJ</th>}
                                    {collectionName === 'properties' && <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Tipo</th>}
                                    {collectionName === 'properties' && <th className="px-6 py-3 text-left font-medium text-gray-500 uppercase">Aluguel</th>}
                                    <th className="px-6 py-3 text-right font-medium text-gray-500 uppercase">Ações</th>
                                </tr>
                                </thead>
                                <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200">
                                {data.length === 0 ? (
                                    <tr>
                                        <td colSpan={collectionName === 'properties' ? 5 : 4} className="px-6 py-4 text-center text-gray-500">Nenhum registro encontrado.</td>
                                    </tr>
                                ) : (
                                    data.map((item) => (
                                        <tr key={item.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <td className="px-6 py-4 whitespace-nowrap font-medium">{item.name || item.address}</td>
                                            {collectionName === 'tenants' && <td className="px-6 py-4 whitespace-nowrap">{item.cpf}</td>}
                                            {collectionName === 'owners' && <td className="px-6 py-4 whitespace-nowrap">{item.cpf}</td>}
                                            {collectionName === 'properties' && <td className="px-6 py-4 whitespace-nowrap">{item.type}</td>}
                                            {collectionName === 'properties' && <td className="px-6 py-4 whitespace-nowrap">{formatCurrency(item.rent)}</td>}
                                            <td className="px-6 py-4 whitespace-nowrap text-right space-x-2">
                                                <Button variant="outline" size="sm" onClick={() => handleEditClick(item)}>Editar</Button>
                                                <Button
                                                    variant="destructive"
                                                    size="sm"
                                                    onClick={() => {
                                                        setConfirmModalData({ collectionName, id: item.id });
                                                        setIsConfirmModalOpen(true);
                                                    }}
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                                </Button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                                </tbody>
                            </table>
                        </div>
                        <Dialog open={isConfirmModalOpen} onOpenChange={setIsConfirmModalOpen} title="Confirmar Exclusão" description="Tem certeza de que deseja excluir este item? Esta ação não pode ser desfeita.">
                            <div className="flex justify-end space-x-2 mt-4">
                                <Button variant="outline" onClick={() => setIsConfirmModalOpen(false)}>Cancelar</Button>
                                <Button variant="destructive" onClick={() => {
                                    if (confirmModalData) {
                                        handleDelete(confirmModalData.collectionName, confirmModalData.id);
                                    }
                                    setIsConfirmModalOpen(false);
                                }}>Excluir</Button>
                            </div>
                        </Dialog>
                    </div>
                );
            };

            const renderView = () => {
                switch (view) {
                    case 'dashboard':
                        return <Dashboard />;
                    case 'tenants':
                        return <TableView title="Inquilinos" collectionName="tenants" data={tenants} FormComponent={TenantForm} />;
                    case 'owners':
                        return <TableView title="Proprietários" collectionName="owners" data={owners} FormComponent={OwnerForm} />;
                    case 'properties':
                        return <TableView title="Imóveis" collectionName="properties" data={properties} FormComponent={PropertyForm} />;
                    case 'payments':
                        return <Payments />;
                    case 'contract':
                        return <ContractView />;
                    default:
                        return <Dashboard />;
                }
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
                        <div className="flex flex-col items-center space-y-4">
                            <div className="animate-spin rounded-full h-12 w-12 border-4 border-gray-900 dark:border-gray-100 border-t-transparent"></div>
                            <p className="text-gray-600 dark:text-gray-400">Carregando...</p>
                        </div>
                    </div>
                );
            }

            if (firebaseError) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-red-50 dark:bg-red-900">
                        <div className="text-center p-8 rounded-lg bg-white dark:bg-gray-800 shadow-xl max-w-lg mx-4">
                            <h2 className="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">Erro de Configuração</h2>
                            <p className="text-gray-700 dark:text-gray-300 mb-4">
                                O aplicativo não pode se conectar ao Firebase. Isso geralmente acontece quando as credenciais não são válidas ou estão ausentes.
                            </p>
                            <p className="text-gray-700 dark:text-gray-300 font-semibold mb-6">
                                Por favor, verifique a mensagem de erro detalhada abaixo e corrija as configurações no seu console do Firebase ou no código.
                            </p>
                            <p className="font-mono text-sm text-red-500 dark:text-red-300">
                                Erro: {firebaseError}
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans flex flex-col md:flex-row">
                    {/* Botão de alternar barra lateral para mobile */}
                    <button
                        onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                        className="fixed top-4 left-4 z-50 md:hidden p-2 rounded-md bg-white dark:bg-gray-800 shadow-lg text-gray-900 dark:text-gray-100"
                        aria-label="Alternar Navegação"
                    >
                        {isSidebarOpen ? (
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-6 w-6"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        ) : (
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-6 w-6"><polyline points="9 18 15 12 9 6"/></svg>
                        )}
                    </button>

                    {/* Sidebar */}
                    <aside
                        className={`fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800 shadow-xl transform transition-transform duration-300 md:relative md:translate-x-0 ${
                            isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                        }`}
                    >
                        <div className="p-6">
                            <h1 className="text-2xl font-bold mb-6">SysAluguel</h1>
                            <nav className="space-y-2">
                                {navigationItems.map((item) => (
                                    <a
                                        key={item.name}
                                        href="#"
                                        onClick={() => {
                                            setView(item.view);
                                            setIsSidebarOpen(false);
                                        }}
                                        className={`flex items-center space-x-3 p-3 rounded-lg transition-colors ${
                                            view === item.view ? 'bg-indigo-600 text-white' : 'hover:bg-gray-200 dark:hover:bg-gray-700'
                                        }`}
                                    >
                                        <div className="h-5 w-5">{item.icon}</div>
                                        <span>{item.name}</span>
                                    </a>
                                ))}
                            </nav>
                        </div>
                    </aside>

                    {/* Conteúdo Principal */}
                    <main className="flex-1 overflow-y-auto pt-16 md:pt-0">
                        <div className="max-w-7xl mx-auto p-4 sm:px-6 lg:px-8">
                            {userId && (
                                <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                                    ID do Usuário: {userId}
                                </p>
                            )}
                            {renderView()}
                        </div>
                    </main>

                    {/* Modal Genérico */}
                    <Dialog open={isModalOpen} onOpenChange={closeModal} title={modalTitle}>
                        {modalContent}
                    </Dialog>
                </div>
            );
        }

        // Renderiza a aplicação
        const container = document.getElementById('root');
        if (container) {
            const root = createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>
